# Overlay Breakdown Post-mortem — 2025-11-09

## Timeline (key inflection points)
- **2025-11-06:** Sprint‑06 tagged `sprint-06-closeout-20251106` (`dfbf54a`) with green baseline; Program.cs refactor queued for next cycle.
- **2025-11-08 09:30:** Overlay re-landing work started inside refactor worktree (`baseline/sprint06-verify`) despite refactor-only scope.
- **2025-11-08 12:10:** First smoke run on `/` red (missing `data-testid="route-node"`); quick patches attempted without plan or reset.
- **2025-11-08 16:40:** Deterministic overlay script added and injected after `home.js`; targeted smoke green, but full suite deferred.
- **2025-11-09 00:50:** Full Playwright run red (`tests/unit/route-adapter-real.spec.ts` ProviderTimeoutError); timeout surfaced only after multiple patch/test loops.
- **2025-11-09 07:45:** BREAKDOWN declared; docs + recovery plan captured; runtime files reverted; pivot to defer overlay (Pivot A).

## Impact
- Lost ~1 sprint-day on a non-scope slice; zero progress on Program.cs refactor.
- Red unit test persisted, eroding CI trust and blocking verification of refactor work.
- Required environment resets and documentation effort; risk of regression increased due to untracked overlay edits.

## How We Drifted & Guardrail Failures
- **Scope drift:** Overlay re-landing was not part of Sprint‑06 closeout or refactor plan. We bypassed the “plan-first” requirement and started implementation in a refactor worktree.
- **Stop-on-RED ignored:** After the first red smoke test we continued patching instead of aborting/replanning; the 3-prompt and 60‑minute caps were not enforced.
- **Baseline discipline missing:** We did not re-verify the baseline after major edits, so the unit red appeared late in the cycle.
- **Guard gaps:** No renderer fingerprint meta-test or script-order guard existed, allowing `/` to diverge silently. Worktree-specific caches muddied results.
- **Communication lag:** No early checkpoint with product or tech leads to confirm “overlay now” vs “Sprint‑07.”

## Root Causes (fishbone → concrete)
- **People:** Assumed overlay work was urgent without confirming backlog priorities; no peer review pause before risky change.
- **Process:** Plan-first template skipped; stop-on-RED and prompt/time caps unenforced; BREAKDOWN protocol triggered only after repeated reds.
- **Tools:** Long-running worktree held stale assets; no automated guard for script order; CI meta suite lacked overlay fingerprint.
- **Code:** Mixed inline/external overlay patterns; legacy `renderRoutePath` wrapper competed with deterministic export; `/` route served a different script order than `/__view-home`.
- **Tests:** Overlay smoke lacked function-body assertion; unit timeout indicated environment interference but was noticed late.
- **Environment:** Local caches and multiple servers left leftovers between attempts; no full reset between major overlay patches.

## 5 Whys (primary chain)
1. Why did `/` lack route nodes? → `window.renderRoutePath` resolved to legacy diagnostic wrapper.
2. Why did wrapper win? → Script order on `/` allowed legacy inline script to load after deterministic overlay.
3. Why was order unchecked? → No meta guard or parity test between `/` and `/__view-home`; assumptions from prior work held.
4. Why were assumptions unchecked? → We pursued quick fixes instead of executing a plan and running baseline verification.
5. Why did we keep patching? → Stop-on-RED guard not enforced; no decision checkpoint, so the team kept iterating past abort thresholds.

## Guardrail & Workflow Changes (recommended)
1. **Pre-flight plan requirement:** For any risky slice (scope change, overlay, provider), require a written one-page plan approved before code execution. Guard enforced via checklist in `docs/code-review.md`.
2. **Prompt/Time cap enforcement:** Update protocol to auto-trigger BREAKDOWN after 3 prompts or 60 minutes without green; log caps in recovery plan and enforce via daily standup checklist.
3. **Overlay freeze flag:** Add CI meta test that fails if overlay assets change on `/` before Sprint‑07 RFC (can leverage lint or script to detect diff). Documented in `docs/Workflow-Tweaks-S6.md`.
4. **Renderer fingerprint guard:** Implement meta smoke verifying `renderRoutePath.toString()` includes `data-testid="route-node"` and script order matches `home.js` → overlay for both `/` and `/__view-home`.
5. **Baseline verification gate:** Mandate full suite + typecheck before starting and after finishing any slice touching `Program.cs` or overlay JS. Record result in `docs/project-history.md` entry.
6. **Environment reset cadence:** Append to protocol: after any BREAKDOWN or major red, reboot IDE/browsers and clean worktree before resuming.

## Corrective Actions (Pivot A focus)
- Defer `/` overlay work to Sprint‑07 with dedicated backlog item and guardrails above.
- Resume Program.cs hardening in small slices: HTML helper extraction, JS module splits (`applySegment`, error constants), script manifest manifesting order once.
- Add meta tests for renderer fingerprints and script order as part of refactor acceptance criteria, even before overlay resumes.

## Verification
- After environment reset: re-run full Playwright + `npm run typecheck` on `baseline/sprint06-verify@dfbf54a` to confirm clean baseline.
- Each refactor slice: run targeted smoke (route-find-real, rate-limit-probe, dir-list, geo-typeahead-a11y, poi-load-timeout) plus full suite + typecheck; record green results.
- CI meta gates updated to include overlay freeze and renderer fingerprint.
- Overlay work remains untouched until Sprint‑07 RFC with approved plan and guards.

## Evidence (to attach)
- Failing spec logs (route-adapter-real ProviderTimeoutError) and DOM snapshots showing missing route nodes on `/`.
- Script order arrays before/after deterministic overlay injection.
- Worktree snapshot: `baseline/sprint06-verify@dfbf54a`, node/dotnet/playwright versions.
